<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><title>PackZen Driver App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#0057ff;--accent:#00c96e;--wa:#25D366;--dark:#050d1a;--text:#1a2744;--text-muted:#5a6a8a;--surface:#fff;--surface2:#f4f7ff;--border:#dde4f5;--shadow-sm:0 2px 12px rgba(0,60,180,.08);--shadow-md:0 8px 32px rgba(0,60,180,.12)}
    body.dark{--text:#e2e8f4;--text-muted:#8a9bbf;--surface:#0d1f3c;--surface2:#091529;--border:#1e3a5f}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'DM Sans',sans-serif;background:var(--surface2);color:var(--text);min-height:100vh;transition:background .3s,color .3s}
    h1,h2,h3{font-family:'Syne',sans-serif}

    /* LOGIN */
    .driver-login{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#050d1a,#0d1f3c);padding:20px}
    .login-card{background:var(--surface);border-radius:24px;padding:40px 36px;max-width:380px;width:100%;box-shadow:0 30px 80px rgba(0,0,0,.4)}
    .login-logo{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:800;color:var(--primary);margin-bottom:4px}
    .login-role{font-size:.8rem;font-weight:700;color:var(--accent);background:rgba(0,201,110,.1);border:1px solid rgba(0,201,110,.3);padding:3px 12px;border-radius:20px;display:inline-block;margin-bottom:20px}
    .field-label{display:block;font-size:.85rem;font-weight:600;color:var(--text-muted);margin-bottom:8px;margin-top:16px}
    .field-input{width:100%;padding:12px 16px;border:1.5px solid var(--border);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:.95rem;color:var(--text);background:var(--surface);outline:none;transition:border-color .2s}
    .field-input:focus{border-color:var(--primary)}
    .btn-auth{width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;margin-top:20px;box-shadow:0 6px 20px rgba(0,87,255,.3);transition:transform .2s}
    .btn-auth:hover{transform:translateY(-2px)}
    .auth-err{font-size:.85rem;color:#e53e3e;margin-top:10px;min-height:18px}

    /* APP */
    .driver-app{display:none;max-width:480px;margin:0 auto;padding:20px;min-height:100vh}
    .driver-app.active{display:block}
    .app-header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,var(--primary),#7c3aed);border-radius:20px;padding:18px 22px;color:#fff;margin-bottom:20px;box-shadow:var(--shadow-md)}
    .app-header-info h2{font-size:1.1rem;font-weight:800}
    .app-header-info p{font-size:.8rem;opacity:.75;margin-top:2px}
    .driver-avatar{width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:800;font-family:'Syne',sans-serif;flex-shrink:0}
    .header-actions{display:flex;gap:8px;align-items:center}
    .theme-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);color:#fff;width:34px;height:34px;border-radius:50%;cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;transition:transform .3s}
    .theme-btn:hover{transform:rotate(20deg)}
    .btn-signout-sm{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);color:#fff;padding:6px 14px;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:background .2s}
    .btn-signout-sm:hover{background:rgba(255,80,80,.3)}

    /* ONLINE TOGGLE */
    .online-card{background:var(--surface);border-radius:18px;border:1px solid var(--border);padding:18px 22px;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;box-shadow:var(--shadow-sm);transition:background .3s}
    .online-label{font-weight:700;font-size:.95rem;color:var(--text)}
    .online-sub{font-size:.78rem;color:var(--text-muted);margin-top:3px}
    .online-dot-big{width:10px;height:10px;border-radius:50%;background:var(--text-muted);display:inline-block;margin-right:8px;transition:background .3s}
    .online-dot-big.on{background:var(--accent);box-shadow:0 0 8px rgba(0,201,110,.6)}
    .toggle-big{position:relative;display:inline-block;width:56px;height:30px}
    .toggle-big input{opacity:0;width:0;height:0}
    .slider-big{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:30px;transition:.3s}
    .slider-big::before{content:'';position:absolute;height:24px;width:24px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    input:checked+.slider-big{background:var(--accent)}
    input:checked+.slider-big::before{transform:translateX(26px)}

    /* BOOKING CARD */
    .booking-card{background:var(--surface);border-radius:18px;border:1px solid var(--border);padding:20px;margin-bottom:16px;box-shadow:var(--shadow-sm);transition:background .3s}
    .booking-card.no-booking{text-align:center;padding:40px 20px}
    .booking-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .booking-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;color:var(--text)}
    .booking-id{font-size:.75rem;color:var(--text-muted);background:var(--surface2);padding:3px 10px;border-radius:20px;border:1px solid var(--border)}
    .info-row{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start}
    .info-icon{font-size:1.1rem;flex-shrink:0;width:22px;text-align:center;margin-top:1px}
    .info-text{font-size:.88rem;color:var(--text);line-height:1.4;flex:1}
    .info-text .lbl{font-size:.75rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px}
    .divider{height:1px;background:var(--border);margin:14px 0}
    .booking-amount{display:flex;justify-content:space-between;align-items:center}
    .ba-lbl{font-size:.82rem;color:var(--text-muted);font-weight:500}
    .ba-val{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;color:var(--primary)}

    /* STATUS BUTTONS */
    .status-section{background:var(--surface);border-radius:18px;border:1px solid var(--border);padding:20px;margin-bottom:16px;box-shadow:var(--shadow-sm);transition:background .3s}
    .status-title{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:800;color:var(--text);margin-bottom:14px}
    .status-steps{display:flex;flex-direction:column;gap:10px}
    .status-step{display:flex;align-items:center;gap:14px;padding:13px 16px;border-radius:14px;border:1.5px solid var(--border);cursor:pointer;transition:all .2s;background:var(--surface2)}
    .status-step:hover{border-color:var(--primary);background:rgba(0,87,255,.04)}
    .status-step.done{border-color:var(--accent);background:rgba(0,201,110,.06)}
    .status-step.active{border-color:var(--primary);background:rgba(0,87,255,.08);box-shadow:0 0 0 3px rgba(0,87,255,.12)}
    .step-icon{font-size:1.4rem;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:rgba(0,87,255,.08);flex-shrink:0}
    .status-step.done .step-icon{background:rgba(0,201,110,.12)}
    .status-step.active .step-icon{background:var(--primary);font-size:1.2rem}
    .step-body{flex:1}
    .step-name{font-weight:700;font-size:.9rem;color:var(--text)}
    .step-desc{font-size:.75rem;color:var(--text-muted);margin-top:2px}
    .step-check{color:var(--accent);font-size:1.1rem}
    .btn-update{width:100%;padding:13px;background:var(--primary);color:#fff;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;box-shadow:0 5px 16px rgba(0,87,255,.3);transition:transform .2s}
    .btn-update:hover{transform:translateY(-2px)}
    .btn-update:disabled{background:var(--text-muted);box-shadow:none;cursor:not-allowed;transform:none}

    /* MAP CARD */
    .map-card{background:var(--surface);border-radius:18px;border:1px solid var(--border);padding:16px 20px;margin-bottom:16px;box-shadow:var(--shadow-sm);transition:background .3s}
    .map-card h3{font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;color:var(--text);margin-bottom:12px}
    #driverMapDiv{height:200px;border-radius:12px;border:1px solid var(--border);overflow:hidden;background:var(--surface2)}
    .location-info{font-size:.8rem;color:var(--text-muted);margin-top:10px;display:flex;align-items:center;gap:6px}
    .loc-dot{width:8px;height:8px;border-radius:50%;background:var(--primary);animation:locPulse 2s infinite;flex-shrink:0}
    @keyframes locPulse{0%,100%{opacity:1}50%{opacity:.4}}

    /* CHAT SECTION */
    .chat-card{background:var(--surface);border-radius:18px;border:1px solid var(--border);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow-sm)}
    .chat-hdr{background:linear-gradient(135deg,var(--primary),#7c3aed);padding:14px 18px;display:flex;align-items:center;gap:10px}
    .chat-hdr-title{font-family:'Syne',sans-serif;font-weight:800;font-size:.9rem;color:#fff}
    .chat-hdr-sub{font-size:.73rem;color:rgba(255,255,255,.7)}
    .chat-messages{height:220px;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px;background:var(--surface2)}
    .chat-bubble{max-width:75%;padding:9px 13px;border-radius:16px;font-size:.86rem;line-height:1.4;word-break:break-word}
    .chat-bubble.mine{background:var(--primary);color:#fff;align-self:flex-end;border-bottom-right-radius:3px}
    .chat-bubble.theirs{background:var(--surface);color:var(--text);align-self:flex-start;border-bottom-left-radius:3px;box-shadow:var(--shadow-sm)}
    .chat-time{font-size:.67rem;opacity:.6;margin-top:2px}
    .chat-empty{text-align:center;color:var(--text-muted);font-size:.82rem;padding:30px}
    .chat-input-row{display:flex;gap:8px;padding:10px 14px;border-top:1px solid var(--border);background:var(--surface)}
    .chat-input{flex:1;padding:9px 13px;border:1.5px solid var(--border);border-radius:25px;font-family:'DM Sans',sans-serif;font-size:.88rem;background:var(--surface2);color:var(--text);outline:none}
    .chat-input:focus{border-color:var(--primary)}
    .btn-send{padding:9px 16px;background:var(--primary);color:#fff;border:none;border-radius:25px;font-size:.85rem;font-weight:700;cursor:pointer;transition:background .2s}
    .btn-send:hover{background:#0040cc}

    /* DELIVERY PHOTOS */
    .photo-card{background:var(--surface);border-radius:18px;border:1px solid var(--border);padding:18px 20px;margin-bottom:16px;box-shadow:var(--shadow-sm)}
    .photo-card h3{font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;color:var(--text);margin-bottom:12px}
    .photo-upload-area{border:2px dashed var(--border);border-radius:12px;padding:18px;text-align:center;cursor:pointer;transition:border-color .2s}
    .photo-upload-area:hover{border-color:var(--primary)}
    .photo-upload-area input{display:none}
    .photo-upload-lbl{font-size:.83rem;color:var(--text-muted)}
    .photo-upload-lbl span{color:var(--primary);font-weight:600}
    .delivery-thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .delivery-thumb{width:62px;height:62px;border-radius:8px;object-fit:cover;border:2px solid var(--border)}
    .btn-upload-photos{width:100%;margin-top:12px;padding:11px;background:rgba(0,201,110,.1);color:var(--accent);border:1.5px solid rgba(0,201,110,.3);border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:background .2s}
    .btn-upload-photos:hover{background:var(--accent);color:#fff}

    /* TOAST */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--dark);color:#fff;padding:12px 24px;border-radius:50px;font-size:.88rem;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;white-space:nowrap}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    @media(max-width:480px){.driver-app{padding:14px}}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="driver-login" id="driverLogin">
  <div class="login-card">
    <div class="login-logo">üì¶ PackZen</div>
    <div class="login-role">üöö Driver Portal</div>
    <label class="field-label">Email</label>
    <input id="drvEmail" type="email" class="field-input" placeholder="driver@packzen.com">
    <label class="field-label">Password</label>
    <input id="drvPass" type="password" class="field-input" placeholder="Password">
    <div id="drvErr" class="auth-err"></div>
    <button class="btn-auth" onclick="driverLogin()">Login ‚Üí</button>
  </div>
</div>

<!-- DRIVER APP -->
<div class="driver-app" id="driverApp">

  <!-- HEADER -->
  <div class="app-header">
    <div style="display:flex;align-items:center;gap:14px">
      <div class="driver-avatar" id="drvAvatar">D</div>
      <div class="app-header-info">
        <h2 id="drvName">Driver</h2>
        <p id="drvEmail2">driver@packzen.com</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="theme-btn" onclick="toggleDriverTheme()">üåô</button>
      <button class="btn-signout-sm" onclick="driverSignOut()">Sign Out</button>
    </div>
  </div>

  <!-- ONLINE TOGGLE -->
  <div class="online-card">
    <div>
      <div class="online-label"><span class="online-dot-big" id="onlineDot"></span><span id="onlineLabel">Offline</span></div>
      <div class="online-sub" id="onlineSub">Toggle to start receiving jobs</div>
    </div>
    <label class="toggle-big">
      <input type="checkbox" id="onlineToggle" onchange="toggleOnline(this.checked)">
      <span class="slider-big"></span>
    </label>
  </div>

  <!-- CURRENT BOOKING -->
  <div class="booking-card" id="bookingCard">
    <div class="booking-header">
      <div class="booking-title">üì¶ Current Assignment</div>
      <div class="booking-id" id="bkId">‚Äî</div>
    </div>
    <div class="info-row"><span class="info-icon">üë§</span><div class="info-text"><span class="lbl">Customer</span><span id="bkCustomer">‚Äî</span></div></div>
    <div class="info-row"><span class="info-icon">üìû</span><div class="info-text"><span class="lbl">Phone</span><a id="bkPhone" href="#" style="color:var(--primary);font-weight:600">‚Äî</a></div></div>
    <div class="info-row"><span class="info-icon">üìç</span><div class="info-text"><span class="lbl">Pickup</span><span id="bkPickup">‚Äî</span></div></div>
    <div class="info-row"><span class="info-icon">üèÅ</span><div class="info-text"><span class="lbl">Drop</span><span id="bkDrop">‚Äî</span></div></div>
    <div class="info-row"><span class="info-icon">üìÖ</span><div class="info-text"><span class="lbl">Date</span><span id="bkDate">‚Äî</span></div></div>
    <div class="divider"></div>
    <div class="booking-amount">
      <div><div class="ba-lbl">Total Amount</div><div class="ba-val" id="bkAmount">‚Çπ0</div></div>
      <a id="bkNavigate" href="#" target="_blank" style="background:var(--accent);color:#fff;padding:8px 18px;border-radius:30px;text-decoration:none;font-size:.82rem;font-weight:700">üó∫Ô∏è Navigate</a>
    </div>
  </div>

  <!-- NO BOOKING STATE -->
  <div class="booking-card no-booking" id="noBookingCard" style="display:none">
    <div style="font-size:3rem;margin-bottom:12px">üöó</div>
    <div style="font-family:'Syne',sans-serif;font-weight:800;color:var(--text);margin-bottom:6px">No Active Booking</div>
    <div style="font-size:.85rem;color:var(--text-muted)">Go online and wait for the admin to assign a job.</div>
  </div>

  <!-- STATUS STEPS -->
  <div class="status-section" id="statusSection">
    <div class="status-title">Update Job Status</div>
    <div class="status-steps" id="statusSteps"></div>
    <button class="btn-update" id="btnUpdateStatus" onclick="updateJobStatus()" style="margin-top:14px">Update Status ‚Üí</button>
  </div>

  <!-- LIVE LOCATION MAP -->
  <div class="map-card">
    <h3>üì° Your Live Location</h3>
    <div id="driverMapDiv"><div style="height:200px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);font-size:.85rem">üìç Map loads when online</div></div>
    <div class="location-info"><span class="loc-dot"></span><span id="locationText">Location not sharing</span></div>
  </div>

  <!-- CHAT -->
  <div class="chat-card" id="chatCard">
    <div class="chat-hdr">
      <div>
        <div class="chat-hdr-title">üí¨ Chat with Customer</div>
        <div class="chat-hdr-sub" id="chatCustomerName">No active booking</div>
      </div>
    </div>
    <div class="chat-messages" id="drvChatMessages"><div class="chat-empty">No messages yet.</div></div>
    <div class="chat-input-row">
      <input type="text" class="chat-input" id="drvChatInput" placeholder="Type message..." onkeydown="if(event.key==='Enter')drvSendMsg()">
      <button class="btn-send" onclick="drvSendMsg()">Send</button>
    </div>
  </div>

  <!-- DELIVERY PHOTOS -->
  <div class="photo-card" id="photoCard">
    <h3>üì∏ Proof of Delivery Photos</h3>
    <div class="photo-upload-area" onclick="document.getElementById('deliveryPhotos').click()">
      <label class="photo-upload-lbl">
        <input type="file" id="deliveryPhotos" multiple accept="image/*" onchange="previewDeliveryPhotos(this)">
        <span>Tap to upload</span> delivery photos
      </label>
    </div>
    <div class="delivery-thumbs" id="deliveryThumbs"></div>
    <button class="btn-upload-photos" onclick="saveDeliveryPhotos()">üì§ Save & Upload Photos</button>
  </div>

</div>

<div class="toast" id="drvToast"></div>

<script src="firebase-config.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdYIaoNUMxf0uWuHmWk_Nu2ppfXFp6VDs"></script>
<script>
let driverUser = null, currentBookingId = null, currentBookingData = null;
let locationInterval = null, driverMap = null, driverMarker = null;
let chatListener = null, bookingListener = null;
let selectedDeliveryPhotos = [];

const STATUS_STEPS = [
  { key: "assigned", icon: "üöõ", name: "Job Assigned",    desc: "You've been assigned to this booking" },
  { key: "packing",  icon: "üì¶", name: "Packing Started", desc: "Items are being packed at pickup" },
  { key: "transit",  icon: "üöö", name: "In Transit",      desc: "Moving items to destination" },
  { key: "delivered",icon: "üéâ", name: "Delivered",       desc: "Items delivered. Job complete!" }
];

function waitFB(cb, n=0) {
  if (window._firebase) { cb(); return; }
  if (n > 30) return;
  setTimeout(() => waitFB(cb, n+1), 200);
}

function toast(msg, dur=3000) {
  const t = document.getElementById("drvToast");
  t.textContent = msg; t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), dur);
}

/* THEME */
function toggleDriverTheme() {
  document.body.classList.toggle("dark");
  document.querySelector(".theme-btn").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("packzen-theme", document.body.classList.contains("dark") ? "dark" : "light");
}
if (localStorage.getItem("packzen-theme") === "dark") {
  document.body.classList.add("dark");
  setTimeout(() => { const b = document.querySelector(".theme-btn"); if(b) b.textContent = "‚òÄÔ∏è"; }, 100);
}

/* LOGIN */
function driverLogin() {
  const email = document.getElementById("drvEmail").value.trim();
  const pass  = document.getElementById("drvPass").value;
  const err   = document.getElementById("drvErr");
  err.textContent = "";
  waitFB(() => {
    const { auth, db } = window._firebase;
    auth.signInWithEmailAndPassword(email, pass)
      .then(cred => db.collection("users").doc(cred.user.uid).get().then(doc => {
        if (!doc.exists || doc.data().role !== "driver") { auth.signOut(); err.textContent = "Access denied. Driver accounts only."; return; }
        driverUser = cred.user;
        showApp(doc.data());
      }))
      .catch(e => { err.textContent = "Login failed: " + (e.code === "auth/wrong-password" ? "Wrong password" : e.message); });
  });
}

function driverSignOut() {
  stopLocationSharing();
  waitFB(() => {
    if (driverUser) window._firebase.db.collection("users").doc(driverUser.uid).update({ isOnline: false });
    window._firebase.auth.signOut().then(() => {
      document.getElementById("driverApp").classList.remove("active");
      document.getElementById("driverLogin").style.display = "flex";
      driverUser = null;
    });
  });
}

function showApp(data) {
  document.getElementById("driverLogin").style.display = "none";
  document.getElementById("driverApp").classList.add("active");
  document.getElementById("drvName").textContent = data.name || "Driver";
  document.getElementById("drvEmail2").textContent = driverUser.email || "";
  document.getElementById("drvAvatar").textContent = (data.name || "D").charAt(0).toUpperCase();
  // Restore online state
  if (data.isOnline) {
    document.getElementById("onlineToggle").checked = true;
    setOnlineUI(true);
    startLocationSharing();
  }
  listenForBooking();
  buildStatusSteps("assigned");
}

waitFB(() => {
  window._firebase.auth.onAuthStateChanged(u => {
    if (!u) return;
    window._firebase.db.collection("users").doc(u.uid).get().then(doc => {
      if (doc.exists && doc.data().role === "driver") { driverUser = u; showApp(doc.data()); }
    });
  });
});

/* ONLINE TOGGLE */
function toggleOnline(online) {
  if (!driverUser) return;
  setOnlineUI(online);
  window._firebase.db.collection("users").doc(driverUser.uid).update({ isOnline: online });
  if (online) startLocationSharing();
  else stopLocationSharing();
}

function setOnlineUI(online) {
  const dot   = document.getElementById("onlineDot");
  const label = document.getElementById("onlineLabel");
  const sub   = document.getElementById("onlineSub");
  dot.className   = "online-dot-big " + (online ? "on" : "");
  label.textContent = online ? "Online" : "Offline";
  sub.textContent   = online ? "You are now visible to admin for job assignments" : "Toggle to start receiving jobs";
}

/* LISTEN FOR BOOKING */
function listenForBooking() {
  if (!driverUser) return;
  if (bookingListener) { bookingListener(); bookingListener = null; }
  bookingListener = window._firebase.db.collection("bookings")
    .where("driverUid", "==", driverUser.uid)
    .where("status", "in", ["assigned","packing","transit"])
    .limit(1)
    .onSnapshot(snap => {
      if (snap.empty) {
        currentBookingId = null; currentBookingData = null;
        document.getElementById("bookingCard").style.display = "none";
        document.getElementById("noBookingCard").style.display = "block";
        document.getElementById("statusSection").style.display = "none";
        document.getElementById("photoCard").style.display = "none";
        document.getElementById("chatCustomerName").textContent = "No active booking";
        document.getElementById("drvChatMessages").innerHTML = '<div class="chat-empty">No active booking.</div>';
        if (chatListener) { chatListener(); chatListener = null; }
        return;
      }
      const doc = snap.docs[0];
      currentBookingId   = doc.id;
      currentBookingData = { id: doc.id, ...doc.data() };
      showBookingUI(currentBookingData);
      buildStatusSteps(currentBookingData.status);
      listenChat();
    });
}

function showBookingUI(b) {
  document.getElementById("bookingCard").style.display = "block";
  document.getElementById("noBookingCard").style.display = "none";
  document.getElementById("statusSection").style.display = "block";
  document.getElementById("photoCard").style.display = b.status === "transit" ? "block" : "none";
  document.getElementById("bkId").textContent      = "#" + b.id.slice(-6).toUpperCase();
  document.getElementById("bkCustomer").textContent = b.customerName || "‚Äî";
  const phoneEl = document.getElementById("bkPhone");
  phoneEl.textContent = b.phone || "‚Äî";
  phoneEl.href = "tel:" + (b.phone || "");
  document.getElementById("bkPickup").textContent  = b.pickup || "‚Äî";
  document.getElementById("bkDrop").textContent    = b.drop   || "‚Äî";
  document.getElementById("bkDate").textContent    = b.date   || "‚Äî";
  document.getElementById("bkAmount").textContent  = "‚Çπ" + (b.total || 0).toLocaleString();
  const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(b.drop||"")}`;
  document.getElementById("bkNavigate").href = navUrl;
  document.getElementById("chatCustomerName").textContent = b.customerName || "Customer";
}

/* STATUS STEPS */
function buildStatusSteps(currentStatus) {
  const container = document.getElementById("statusSteps");
  const statusOrder = ["assigned","packing","transit","delivered"];
  const currentIdx  = statusOrder.indexOf(currentStatus);
  container.innerHTML = STATUS_STEPS.map((step, i) => {
    let cls = "status-step";
    let check = "";
    if (i < currentIdx)  { cls += " done"; check = '<span class="step-check">‚úì</span>'; }
    if (i === currentIdx) cls += " active";
    return `<div class="${cls}">
      <div class="step-icon">${i === currentIdx ? "‚ñ∂" : step.icon}</div>
      <div class="step-body"><div class="step-name">${step.name}</div><div class="step-desc">${step.desc}</div></div>
      ${check}
    </div>`;
  }).join("");

  // Next status button
  const btn = document.getElementById("btnUpdateStatus");
  const nextIdx = currentIdx + 1;
  if (nextIdx < STATUS_STEPS.length) {
    btn.disabled = false;
    btn.textContent = `Mark as "${STATUS_STEPS[nextIdx].name}" ‚Üí`;
  } else {
    btn.disabled = true;
    btn.textContent = "‚úÖ Job Completed!";
  }
}

function updateJobStatus() {
  if (!currentBookingId || !currentBookingData) return;
  const statusOrder = ["assigned","packing","transit","delivered"];
  const currentIdx  = statusOrder.indexOf(currentBookingData.status);
  const nextStatus  = statusOrder[currentIdx + 1];
  if (!nextStatus) return;

  window._firebase.db.collection("bookings").doc(currentBookingId).update({ status: nextStatus })
    .then(() => {
      currentBookingData.status = nextStatus;
      buildStatusSteps(nextStatus);
      toast("‚úÖ Status updated: " + nextStatus);
      if (nextStatus === "delivered") {
        document.getElementById("photoCard").style.display = "block";
        toast("üéâ Job delivered! Upload proof photos.", 4000);
      }
    })
    .catch(e => toast("‚ùå Error: " + e.message));
}

/* LOCATION SHARING */
function startLocationSharing() {
  if (!navigator.geolocation) { toast("‚ö†Ô∏è Geolocation not supported"); return; }
  shareLocation();
  locationInterval = setInterval(shareLocation, 15000);
  initDriverMap();
}

function stopLocationSharing() {
  if (locationInterval) { clearInterval(locationInterval); locationInterval = null; }
  document.getElementById("locationText").textContent = "Location not sharing";
}

function shareLocation() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      const now = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      document.getElementById("locationText").textContent = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)} ‚Äî Updated ${now}`;
      if (driverUser) {
        const db = window._firebase.db;
        db.collection("users").doc(driverUser.uid).update({ lat, lng, locationUpdatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        if (currentBookingId) db.collection("bookings").doc(currentBookingId).update({ driverLat: lat, driverLng: lng, locationUpdatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
      updateDriverMap(lat, lng);
    },
    err => { document.getElementById("locationText").textContent = "Location error: " + err.message; },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

function initDriverMap() {
  const mapDiv = document.getElementById("driverMapDiv");
  if (typeof google === "undefined" || !google.maps) return;
  driverMap = new google.maps.Map(mapDiv, { zoom: 15, center: { lat: 12.97, lng: 77.59 } });
}

function updateDriverMap(lat, lng) {
  if (!driverMap) initDriverMap();
  if (!driverMap) return;
  const pos = { lat, lng };
  driverMap.setCenter(pos);
  if (driverMarker) driverMarker.setPosition(pos);
  else driverMarker = new google.maps.Marker({ map: driverMap, position: pos, title: "You", icon: { url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png" } });
}

/* CHAT */
function listenChat() {
  if (!currentBookingId) return;
  if (chatListener) { chatListener(); chatListener = null; }
  chatListener = window._firebase.db.collection("chats").doc(currentBookingId)
    .collection("messages").orderBy("time", "asc")
    .onSnapshot(snap => {
      const container = document.getElementById("drvChatMessages");
      if (snap.empty) { container.innerHTML = '<div class="chat-empty">No messages yet.</div>'; return; }
      container.innerHTML = "";
      snap.forEach(d => {
        const msg  = d.data();
        const mine = msg.senderUid === driverUser?.uid;
        const time = msg.time?.toDate ? msg.time.toDate().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) : "";
        container.innerHTML += `<div class="chat-bubble ${mine?"mine":"theirs"}"><div>${msg.text}</div><div class="chat-time">${time}</div></div>`;
      });
      container.scrollTop = container.scrollHeight;
    });
}

function drvSendMsg() {
  const input = document.getElementById("drvChatInput");
  const text  = input.value.trim();
  if (!text) return;
  if (!currentBookingId) { toast("‚ö†Ô∏è No active booking"); return; }
  input.value = "";
  window._firebase.db.collection("chats").doc(currentBookingId).collection("messages").add({
    text, senderUid: driverUser?.uid, senderName: driverUser?.displayName || "Driver",
    role: "driver", time: firebase.firestore.FieldValue.serverTimestamp()
  }).catch(e => toast("Send failed: " + e.message));
}

/* DELIVERY PHOTOS */
function previewDeliveryPhotos(input) {
  const thumbs = document.getElementById("deliveryThumbs");
  thumbs.innerHTML = "";
  selectedDeliveryPhotos = [];
  Array.from(input.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      selectedDeliveryPhotos.push(e.target.result);
      const img = document.createElement("img");
      img.src = e.target.result; img.className = "delivery-thumb";
      thumbs.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
}

function saveDeliveryPhotos() {
  if (!currentBookingId || !selectedDeliveryPhotos.length) { toast("‚ö†Ô∏è Take photos first"); return; }
  window._firebase.db.collection("bookings").doc(currentBookingId).update({
    deliveryPhotos: selectedDeliveryPhotos.slice(0, 5),
    photosUploadedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => toast("‚úÖ Delivery photos saved!"))
    .catch(e => toast("‚ùå " + e.message));
}
</script>
</body>
</html>
